<!DOCTYPE html>
<html lang="en" class="bg-black text-zinc-300">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Reader</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,500;0,600;1,400&family=Inter:wght@300;400;500;600&display=swap');
        
        .font-editorial { font-family: 'Lora', serif; }
        .font-sans { font-family: 'Inter', sans-serif; }
        
        body { background-color: #000000; color: #d4d4d8; }
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .feed-divider { background: #27272a; height: 1px; width: 100%; }
        .tab-active { color: #f4f4f5; border-bottom: 1px solid #f4f4f5; }
    </style>
</head>
<body class="antialiased selection:bg-zinc-800 font-sans">

    <div class="max-w-6xl mx-auto px-6 pt-8 pb-24">
        <div class="flex justify-between items-center border-b border-zinc-800 pb-3 mb-8">
            <div class="flex space-x-8 text-[0.75rem] font-medium text-zinc-500 uppercase tracking-widest" id="tabs">
                <button onclick="switchTab('monthly')" id="tab-monthly" class="tab-active pb-3 transition-colors hover:text-zinc-300">Monthly</button>
                <button onclick="switchTab('yearly')" id="tab-yearly" class="pb-3 transition-colors hover:text-zinc-300">Yearly</button>
                <button onclick="switchTab('news')" id="tab-news" class="pb-3 transition-colors hover:text-zinc-300">Daily Star</button>
                <button onclick="switchTab('ritholtz')" id="tab-ritholtz" class="pb-3 transition-colors hover:text-zinc-300">AM Reads</button>
                <button onclick="switchTab('favorites')" id="tab-favorites" class="pb-3 transition-colors hover:text-amber-600">★ Favorites</button>
            </div>
            <label class="text-[0.65rem] uppercase tracking-widest text-zinc-500 flex items-center cursor-pointer hover:text-zinc-300 transition-colors">
                <input type="checkbox" id="showReadToggle" class="mr-2 accent-zinc-600" onchange="fetchData()"> Show Read
            </label>
        </div>

        <div id="feed" class="space-y-0"></div>
    </div>

    <script>
        let appData = { monthly: [], yearly: [], news: [], ritholtz: [] };
        let currentTab = 'monthly';

        async function fetchData() {
            const showRead = document.getElementById('showReadToggle').checked;
            document.getElementById('feed').innerHTML = '<div class="text-zinc-600 text-xs py-10 text-center animate-pulse tracking-widest uppercase">Loading feed...</div>';
            
            const res = await fetch(`/api/data?show_read=${showRead}`);
            appData = await res.json();
            renderFeed();
        }

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('#tabs button').forEach(b => b.classList.remove('tab-active', 'text-zinc-200'));
            document.getElementById(`tab-${tab}`).classList.add('tab-active');
            renderFeed();
        }

        async function toggleAction(id, action, btnElement) {
            btnElement.style.transform = "scale(1.15)";
            setTimeout(() => btnElement.style.transform = "scale(1)", 150);

            const res = await fetch('/api/toggle', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({id, action})
            });
            const result = await res.json();
            
            // 1. Update local data cache so tab switching remains accurate
            const updateCache = (arr) => {
                arr.forEach(item => {
                    if (item.id === id) {
                        if (action === 'read') item.is_read = result.is_active;
                        if (action === 'fav') item.is_fav = result.is_active;
                    }
                });
            };
            updateCache(appData.monthly);
            updateCache(appData.yearly);
            updateCache(appData.news);
            updateCache(appData.ritholtz);

            // 2. Check if we need to hide the item from the current view
            const showRead = document.getElementById('showReadToggle').checked;
            const container = btnElement.closest('.group');
            let shouldHide = false;

            if (action === 'read' && result.is_active && !showRead) {
                shouldHide = true; // Hide if marked read and "Show Read" is off
            } else if (action === 'fav' && !result.is_active && currentTab === 'favorites') {
                shouldHide = true; // Hide if unfavorited while inside Favorites tab
            } else if (action === 'fav' && result.is_active && currentTab !== 'favorites') {
                shouldHide = true; // Hide from main feed if favorited (moves to favorites)
            }

            // 3. Smoothly fade out without losing scroll position, or just update button
            if (shouldHide) {
                container.style.transition = "opacity 0.2s ease, height 0.2s ease";
                container.style.opacity = "0";
                setTimeout(() => container.style.display = "none", 200);
            } else {
                if (action === 'fav') {
                    btnElement.innerHTML = result.is_active ? '★' : '☆';
                    btnElement.className = result.is_active ? 'text-amber-500 hover:text-amber-400 transition-all text-lg focus:outline-none' : 'text-zinc-700 hover:text-zinc-500 transition-all text-lg focus:outline-none';
                } else {
                    btnElement.innerHTML = result.is_active ? '↺' : '✓';
                    btnElement.className = result.is_active ? 'text-zinc-700 hover:text-zinc-500 transition-all text-lg focus:outline-none' : 'text-zinc-400 hover:text-zinc-200 transition-all text-lg focus:outline-none';
                }
            }
        }

        function renderFeed() {
            let items = [];
            if (currentTab === 'favorites') {
                items = [...appData.monthly, ...appData.yearly, ...appData.news, ...appData.ritholtz].filter(i => i.is_fav);
                items = Array.from(new Map(items.map(item => [item.id, item])).values()); 
            } else {
                // CRITICAL FIX: Hide favorited items from the main feed
                items = (appData[currentTab] || []).filter(i => !i.is_fav);
            }

            const feed = document.getElementById('feed');
            if (items.length === 0) {
                feed.innerHTML = '<div class="text-zinc-600 text-xs py-10 text-center uppercase tracking-widest">No items found.</div>';
                return;
            }

            feed.innerHTML = items.map(item => `
                <div class="group py-4 relative flex flex-col justify-center">
                    <div class="flex justify-between items-start">
                        <div class="pr-12 flex-1">
                            <a href="${item.url}" target="_blank" rel="noopener noreferrer" class="font-editorial text-[1.05rem] font-medium text-zinc-100 hover:text-zinc-400 leading-snug transition-colors block mb-1.5">
                                ${item.title}
                            </a>
                            ${item.desc ? `<div class="text-[0.8rem] text-zinc-500 leading-relaxed line-clamp-2 mb-2 font-light">${item.desc}</div>` : ''}
                            <div class="text-[0.65rem] font-medium uppercase tracking-widest text-zinc-600 mt-1.5">
                                ${item.meta}
                            </div>
                        </div>
                        <div class="flex items-center space-x-5 pt-1 flex-shrink-0">
                            <button onclick="toggleAction('${item.id}', 'fav', this)" class="transition-all text-lg focus:outline-none ${item.is_fav ? 'text-amber-500 hover:text-amber-400' : 'text-zinc-700 hover:text-zinc-500'}" title="Toggle Favorite">
                                ${item.is_fav ? '★' : '☆'}
                            </button>
                            <button onclick="toggleAction('${item.id}', 'read', this)" class="transition-all text-lg focus:outline-none ${item.is_read ? 'text-zinc-700 hover:text-zinc-500' : 'text-zinc-400 hover:text-zinc-200'}" title="Toggle Read">
                                ${item.is_read ? '↺' : '✓'}
                            </button>
                        </div>
                    </div>
                    <div class="feed-divider mt-5"></div>
                </div>
            `).join('');
        }

        fetchData();
    </script>
</body>
</html>