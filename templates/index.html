<!DOCTYPE html>
<html lang="en" class="bg-black text-zinc-300">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Reader</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,500;0,600;1,400&family=Inter:wght@300;400;500;600&display=swap');
        
        .font-editorial { font-family: 'Lora', serif; }
        .font-sans { font-family: 'Inter', sans-serif; }
        
        body { background-color: #000000; color: #d4d4d8; }
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .feed-divider { background: #27272a; height: 1px; width: 100%; }
        .tab-active { color: #f4f4f5; border-bottom: 1px solid #f4f4f5; }
        
        /* Active state styling */
        .active-fav { color: #fbbf24 !important; /* gold */ }
        .active-read { color: #34d399 !important; /* green */ }
        .dimmed-read-post { opacity: 0.5; }
        
        /* Default button states */
        .fav-btn { color: #3f3f46; }
        .fav-btn:hover { color: #a1a1aa; }
        .read-btn { color: #71717a; }
        .read-btn:hover { color: #d4d4d8; }
        
        /* Dimming for RSS/dummy scores */
        .post-meta { font-family: monospace; font-size: 0.85rem; color: #888; }
    </style>

</head>
<body class="antialiased selection:bg-zinc-800 font-sans">

    <div class="max-w-6xl mx-auto px-6 pt-8 pb-24 relative">
        
        <div class="sticky top-0 z-50 flex justify-between items-center border-b border-zinc-800/40 pb-3 mb-8 pt-8 -mt-8 bg-black/70 backdrop-blur-md transition-all">
            <div class="flex space-x-8 text-[0.75rem] font-medium text-zinc-500 uppercase tracking-widest" id="tabs">
                <button onclick="switchTab('monthly')" id="tab-monthly" class="tab-active pb-3 transition-colors hover:text-zinc-300">Monthly</button>
                <button onclick="switchTab('yearly')" id="tab-yearly" class="pb-3 transition-colors hover:text-zinc-300">Yearly</button>
                <button onclick="switchTab('news')" id="tab-news" class="pb-3 transition-colors hover:text-zinc-300">Google News</button>
                <button onclick="switchTab('ritholtz')" id="tab-ritholtz" class="pb-3 transition-colors hover:text-zinc-300">AM Reads</button>
                <button onclick="switchTab('favorites')" id="tab-favorites" class="pb-3 transition-colors hover:text-amber-600">★ Favorites</button>
            </div>
            <label class="text-[0.65rem] uppercase tracking-widest text-zinc-500 flex items-center cursor-pointer hover:text-zinc-300 transition-colors">
                <input type="checkbox" id="showReadToggle" class="mr-2 accent-zinc-600" onchange="toggleShowRead()"> Show Read
            </label>

        </div>

        <div id="feed" class="space-y-0"></div>
    </div>

    <script>
        // --- 1. INITIALIZE LOCAL STATE ---
        let readPosts = new Set(JSON.parse(localStorage.getItem('reddit_dash_read')) || []);
        let favPosts = new Set(JSON.parse(localStorage.getItem('reddit_dash_fav')) || []);
        let showRead = JSON.parse(localStorage.getItem('reddit_dash_show_read')) || false;
        let allData = { monthly: [], yearly: [], news: [], ritholtz: [] };
        let currentTab = 'monthly';

        // --- 2. SAVE STATE HELPER ---
        function saveState() {
            localStorage.setItem('reddit_dash_read', JSON.stringify([...readPosts]));
            localStorage.setItem('reddit_dash_fav', JSON.stringify([...favPosts]));
            localStorage.setItem('reddit_dash_show_read', JSON.stringify(showRead));
        }

        // --- 3. TOGGLE ACTIONS ---
        window.toggleRead = function(id) {
            if (readPosts.has(id)) {
                readPosts.delete(id);
            } else {
                readPosts.add(id);
            }
            saveState();
            renderFeed(); // Re-render the current tab to reflect changes
        };

        window.toggleFav = function(id) {
            if (favPosts.has(id)) {
                favPosts.delete(id);
            } else {
                favPosts.add(id);
            }
            saveState();
            renderFeed();
        };

        window.toggleShowRead = function() {
            showRead = !showRead;
            saveState();
            
            // Update the UI checkbox to match state
            const checkbox = document.getElementById('showReadToggle');
            if (checkbox) checkbox.checked = showRead;
            
            renderFeed();
        };

        // --- 4. DATA FETCHING ---
        async function loadData() {
            try {
                const response = await fetch('/api/data');
                allData = await response.json();
                renderFeed();
            } catch (error) {
                console.error("Error fetching data:", error);
            }
        }

        // --- 5. TAB SWITCHING ---
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('#tabs button').forEach(b => b.classList.remove('tab-active', 'text-zinc-200'));
            document.getElementById(`tab-${tab}`).classList.add('tab-active');
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
            renderFeed();
        }

        // --- 6. RENDERING LOGIC ---
        function renderFeed() {
            const container = document.getElementById('feed');
            container.innerHTML = '';
            
            // Determine which dataset to use based on the active tab
            let itemsToRender = [];
            if (currentTab === 'favorites') {
                // Flatten all categories and filter only favorites
                const allItems = [...allData.monthly, ...allData.yearly, ...allData.news, ...allData.ritholtz];
                // Deduplicate in case a favorite exists in multiple arrays
                const uniqueItems = Array.from(new Map(allItems.map(item => [item.id, item])).values());
                itemsToRender = uniqueItems.filter(item => favPosts.has(item.id));
            } else {
                itemsToRender = allData[currentTab] || [];
            }

            if (itemsToRender.length === 0) {
                container.innerHTML = '<div class="text-zinc-600 text-xs py-10 text-center uppercase tracking-widest">No items found.</div>';
                return;
            }

            itemsToRender.forEach(post => {
                const isRead = readPosts.has(post.id);
                const isFav = favPosts.has(post.id);

                // FILTER: Skip rendering if it's read, not a favorite, and "Show Read" is false
                if (!showRead && isRead && !isFav && currentTab !== 'favorites') {
                    return; 
                }

                // Determine CSS classes for active icons
                const favClass = isFav ? 'active-fav' : '';
                const readClass = isRead ? 'active-read' : '';
                
                // Build the HTML for the post
                const postElement = document.createElement('div');
                postElement.className = `group py-4 px-5 -mx-5 relative flex flex-col justify-center rounded-2xl transition-all duration-500 hover:bg-zinc-900/20 ${isRead ? 'dimmed-read-post' : ''}`;
                postElement.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="pr-12 flex-1">
                            <a href="${post.url}" target="_blank" rel="noopener noreferrer" class="font-editorial text-[1.05rem] font-medium text-zinc-100 hover:text-zinc-400 leading-snug transition-colors block mb-1.5">
                                ${post.title}
                            </a>
                            ${post.desc ? `<div class="text-[0.8rem] text-zinc-500 leading-relaxed line-clamp-2 mb-2 font-light">${post.desc}</div>` : ''}
                            <div class="text-[0.65rem] font-medium uppercase tracking-widest text-zinc-600 mt-1.5">
                                ${post.meta}
                            </div>
                        </div>
                        <div class="flex items-center space-x-5 pt-1 flex-shrink-0">
                            <button onclick="toggleFav('${post.id}')" class="fav-btn transition-all text-lg focus:outline-none ${favClass}" title="Toggle Favorite">
                                ${isFav ? '★' : '☆'}
                            </button>
                            <button onclick="toggleRead('${post.id}')" class="read-btn transition-all text-lg focus:outline-none ${readClass}" title="Toggle Read">
                                ${isRead ? '↺' : '✓'}
                            </button>
                        </div>
                    </div>
                    <div class="feed-divider mt-5 opacity-40 group-hover:opacity-100 transition-opacity duration-500"></div>
                `;
                container.appendChild(postElement);
            });
        }

        // --- 7. INITIALIZATION ---
        // Initialize checkbox state from localStorage
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('showReadToggle').checked = showRead;
            loadData();
        });
    </script>
</body>
</html>
