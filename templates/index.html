<!DOCTYPE html>
<html lang="en" class="bg-black text-zinc-300">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Reader</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,500;0,600;1,400&family=Inter:wght@300;400;500;600&display=swap');
        
        .font-editorial { font-family: 'Lora', serif; }
        .font-sans { font-family: 'Inter', sans-serif; }
        
        body { background-color: #000000; color: #d4d4d8; }
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .feed-divider { background: #27272a; height: 1px; width: 100%; }
        .tab-active { color: #f4f4f5; border-bottom: 1px solid #f4f4f5; }
        
        /* Active state styling */
        .active-fav { color: #fbbf24 !important; /* gold */ }
        .active-read { color: #34d399 !important; /* green */ }
        .dimmed-read-post { opacity: 0.5; }
        
        /* Default button states */
        .fav-btn { color: #3f3f46; }
        .fav-btn:hover { color: #a1a1aa; }
        .read-btn { color: #71717a; }
        .read-btn:hover { color: #d4d4d8; }
        
        /* Dimming for RSS/dummy scores */
        .post-meta { font-family: monospace; font-size: 0.85rem; color: #888; }
        
        /* Hide scrollbar for Chrome, Safari and Opera */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        /* Hide scrollbar for IE, Edge and Firefox */
        .hide-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
    </style>

</head>
<body class="antialiased selection:bg-zinc-800 font-sans">

    <div class="max-w-6xl mx-auto px-6 pt-8 pb-24 relative">
        
        <div class="sticky top-0 z-50 flex justify-between items-center border-b border-zinc-800/40 pb-3 mb-8 pt-8 -mt-8 bg-black/70 backdrop-blur-md transition-all">
            <div class="flex space-x-6 overflow-x-auto hide-scrollbar text-[0.75rem] font-medium text-zinc-500 uppercase tracking-widest flex-1 pr-4" id="tabs">
                <button onclick="switchTab('monthly')" id="tab-monthly" class="tab-active pb-3 flex-shrink-0 transition-colors hover:text-zinc-300">Monthly</button>
                <button onclick="switchTab('yearly')" id="tab-yearly" class="pb-3 flex-shrink-0 transition-colors hover:text-zinc-300">Yearly</button>
                <button onclick="switchTab('news')" id="tab-news" class="pb-3 flex-shrink-0 transition-colors hover:text-zinc-300">Google News</button>
                <button onclick="switchTab('ritholtz')" id="tab-ritholtz" class="pb-3 flex-shrink-0 transition-colors hover:text-zinc-300">AM Reads</button>
                <button onclick="switchTab('favorites')" id="tab-favorites" class="pb-3 flex-shrink-0 transition-colors hover:text-amber-600">★ Favorites</button>
            </div>
            
            <div style="display: inline-flex; align-items: center; opacity: 0.4; margin-left: auto; padding-left: 10px;" title="Show Read Items">
                <input type="checkbox" id="showReadToggle" onclick="toggleShowRead()" style="accent-color: #555; width: 14px; height: 14px; margin: 0; cursor: pointer; filter: grayscale(100%);">
            </div>
        </div>

        <!-- Search Input for Favorites Tab -->
        <input type="text" id="favoritesSearch" placeholder="Type to filter favorites..." style="display: none; width: 100%; padding: 10px 0; margin-bottom: 25px; background: transparent; color: #fff; border: none; border-bottom: 1px solid #333; border-radius: 0; font-size: 0.95em; outline: none; opacity: 0.6; transition: opacity 0.2s;" onfocus="this.style.opacity='1'" onblur="this.style.opacity='0.6'">

        <div id="feed" class="space-y-0"></div>

        <!-- Sync Settings UI (Footer) -->
        <div id="syncUI" style="display: none; justify-content: space-between; align-items: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #27272a; font-size: 0.85em; color: #71717a;"></div>
    </div>

    <script>
        // --- FIREBASE CONFIG & INITIALIZATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyCUpI5Fzax4MmiwF5ihZZAx5brEd0dOmSE",
            authDomain: "dailyreadersync.firebaseapp.com",
            projectId: "dailyreadersync",
            storageBucket: "dailyreadersync.firebasestorage.app",
            messagingSenderId: "132679444670",
            appId: "1:132679444670:web:d6eede43f3dbb47a6616ef",
            measurementId: "G-5CWJLL7L66"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let cloudFavorites = []; // Will hold our synced data locally for fast UI renders
        let syncKey = localStorage.getItem('dailyReaderSyncKey');

        // --- FIREBASE SYNC FUNCTIONS ---
        function initSync() {
            if (!syncKey) {
                // Generate a random 6-character alphanumeric key
                syncKey = Math.random().toString(36).substring(2, 8).toUpperCase();
                localStorage.setItem('dailyReaderSyncKey', syncKey);
            }
            
            auth.signInAnonymously().then(() => {
                console.log("Connected to Cloud Sync. Key:", syncKey);
                migrateLocalToCloud(); // Run migration once
                listenToFavorites(); // Start real-time sync
            }).catch(error => console.error("Sync Auth Failed:", error));
        }

        function migrateLocalToCloud() {
            let localFavs = JSON.parse(localStorage.getItem('favorites') || '[]');
            if (localFavs.length > 0) {
                const batch = db.batch();
                localFavs.forEach(item => {
                    // Use a safe ID (hash the URL or title)
                    const safeId = (item.url || item.title).replace(/[^a-zA-Z0-9]/g, '');
                    const docRef = db.collection('sync_groups').doc(syncKey).collection('favorites').doc(safeId);
                    batch.set(docRef, item);
                });
                batch.commit().then(() => {
                    console.log("Migrated local favorites to cloud.");
                    localStorage.removeItem('favorites'); // Clear local so we rely on cloud
                });
            }
        }

        function listenToFavorites() {
            db.collection('sync_groups').doc(syncKey).collection('favorites')
                .onSnapshot((snapshot) => {
                    cloudFavorites = [];
                    snapshot.forEach((doc) => {
                        cloudFavorites.push(doc.data());
                    });
                    // Re-render feed if we are on the favorites tab, or if buttons need updating
                    renderFeed(); 
                });
        }

        // --- 1. INITIALIZE LOCAL STATE ---
        let readPosts = new Set(JSON.parse(localStorage.getItem('reddit_dash_read')) || []);
        let showRead = JSON.parse(localStorage.getItem('reddit_dash_show_read')) || false;
        let allData = { monthly: [], yearly: [], news: [], ritholtz: [] };
        let currentTab = 'monthly';

        // --- 1.5. SEARCH INPUT EVENT LISTENER ---
        document.getElementById('favoritesSearch').addEventListener('input', () => {
            renderFeed();
        });

        // --- 2. SAVE STATE HELPER ---
        function saveState() {
            localStorage.setItem('reddit_dash_read', JSON.stringify([...readPosts]));
            localStorage.setItem('reddit_dash_show_read', JSON.stringify(showRead));
        }

        // --- 3. TOGGLE ACTIONS ---
        window.toggleRead = function(id) {
            if (readPosts.has(id)) {
                readPosts.delete(id);
            } else {
                readPosts.add(id);
            }
            saveState();
            renderFeed(); // Re-render the current tab to reflect changes
        };

        // Helper to get safeId for cloud favorites
        function getSafeId(item) {
            return (item.url || item.title).replace(/[^a-zA-Z0-9]/g, '');
        }

        // Helper to check if item is favorited
        function isFavorited(item) {
            const safeId = getSafeId(item);
            return cloudFavorites.some(fav => getSafeId(fav) === safeId);
        }

        window.toggleFav = function(id) {
            // Find the item in allData
            let item = null;
            for (const category of Object.values(allData)) {
                item = category.find(p => p.id === id);
                if (item) break;
            }
            
            if (!item) return;
            
            const safeId = getSafeId(item);
            
            if (isFavorited(item)) {
                // Remove from cloud
                db.collection('sync_groups').doc(syncKey).collection('favorites').doc(safeId).delete();
            } else {
                // Add to cloud
                db.collection('sync_groups').doc(syncKey).collection('favorites').doc(safeId).set(item);
            }
        };

        window.toggleShowRead = function() {
            showRead = !showRead;
            saveState();
            
            // Update the UI checkbox to match state
            const checkbox = document.getElementById('showReadToggle');
            if (checkbox) checkbox.checked = showRead;
            
            renderFeed();
        };

        // --- 4. DATA FETCHING ---
        async function loadData() {
            try {
                const response = await fetch('/api/data');
                allData = await response.json();
                renderFeed();
            } catch (error) {
                console.error("Error fetching data:", error);
            }
        }

        // --- 5. TAB SWITCHING ---
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('#tabs button').forEach(b => b.classList.remove('tab-active', 'text-zinc-200'));
            document.getElementById(`tab-${tab}`).classList.add('tab-active');
            
            // Toggle search bar visibility - only show on Favorites tab
            const searchInput = document.getElementById('favoritesSearch');
            if (currentTab === 'favorites') {
                searchInput.style.display = 'block';
            } else {
                searchInput.style.display = 'none';
                searchInput.value = ''; // clear search when leaving tab
            }
            
            // Update sync UI visibility
            updateSyncUI();
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
            renderFeed();
        }

        // --- 6. SCORE FORMATTING HELPER ---
        function formatScore(score) {
            const num = parseInt(score);
            if (isNaN(num)) return "0";
            if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'k';
            }
            return num.toString();
        }

        // --- 7. RENDERING LOGIC ---
        function renderFeed() {
            const container = document.getElementById('feed');
            container.innerHTML = '';
            
            // Determine which dataset to use based on the active tab
            let itemsToRender = [];
            if (currentTab === 'favorites') {
                // Use cloudFavorites for the favorites tab
                itemsToRender = cloudFavorites;
            } else {
                itemsToRender = allData[currentTab] || [];
            }

            // Apply search filtering for favorites tab
            if (currentTab === 'favorites') {
                const searchQuery = document.getElementById('favoritesSearch').value.toLowerCase();
                if (searchQuery) {
                    itemsToRender = itemsToRender.filter(item => {
                        const titleMatch = (item.title || "").toLowerCase().includes(searchQuery);
                        const subMatch = (item.meta || "").toLowerCase().includes(searchQuery);
                        return titleMatch || subMatch;
                    });
                }
            }

            if (itemsToRender.length === 0) {
                container.innerHTML = '<div class="text-zinc-600 text-xs py-10 text-center uppercase tracking-widest">No items found.</div>';
                return;
            }

            itemsToRender.forEach(post => {
                const isRead = readPosts.has(post.id);
                const isFav = isFavorited(post);
                const cleanMeta = (post.meta || "").split(" • ⏱️")[0];

                // FILTER: Skip rendering if it's read and "Show Read" is false
                if (!showRead && isRead && currentTab !== 'favorites') {
                    return; 
                }

                // Determine CSS classes for active icons
                const favClass = isFav ? 'active-fav' : '';
                const readClass = isRead ? 'active-read' : '';
                
                // Build the HTML for the post
                const postElement = document.createElement('div');
                postElement.className = `group py-4 px-5 -mx-5 relative flex flex-col justify-center rounded-2xl transition-all duration-500 hover:bg-zinc-900/20 ${isRead ? 'dimmed-read-post' : ''}`;
                postElement.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="pr-12 flex-1">
                            <a href="${post.url}" target="_blank" rel="noopener noreferrer" class="font-editorial text-[1.05rem] font-medium text-zinc-100 hover:text-zinc-400 leading-snug transition-colors block mb-1.5">
                                ${post.title}
                            </a>
                            ${post.desc ? `<div class="text-[0.8rem] text-zinc-500 leading-relaxed line-clamp-2 mb-2 font-light">${post.desc}</div>` : ''}
                            <div class="text-[0.65rem] font-medium uppercase tracking-widest text-zinc-600 mt-1.5">
                                ${cleanMeta}
                            </div>
                        </div>
                        <div class="flex items-center space-x-5 pt-1 flex-shrink-0">
                            <button onclick="toggleFav('${post.id}')" class="fav-btn transition-all text-lg focus:outline-none ${favClass}" title="Toggle Favorite">
                                ${isFav ? '★' : '☆'}
                            </button>
                            <button onclick="toggleRead('${post.id}')" class="read-btn transition-all text-lg focus:outline-none ${readClass}" title="Toggle Read">
                                ${isRead ? '↺' : '✓'}
                            </button>
                        </div>
                    </div>
                    <div class="feed-divider mt-5 opacity-40 group-hover:opacity-100 transition-opacity duration-500"></div>
                `;
                container.appendChild(postElement);
            });
        }

        // --- 8. SYNC UI & LINK DEVICE ---
        function promptLinkDevice() {
            const newKey = prompt("Enter the Sync Key from your other device:");
            if (newKey && newKey.trim()) {
                localStorage.setItem('dailyReaderSyncKey', newKey.trim().toUpperCase());
                window.location.reload();
            }
        }

        function updateSyncUI() {
            const syncUI = document.getElementById('syncUI');
            if (currentTab === 'favorites') {
                syncUI.style.display = 'flex';
                syncUI.innerHTML = `<span>Sync Key: <strong>${syncKey}</strong></span> <button onclick="promptLinkDevice()" style="background:none; border:none; color:#4a90e2; cursor:pointer;">Link Existing Device</button>`;
            } else {
                syncUI.style.display = 'none';
            }
        }

        // --- 9. INITIALIZATION ---
        // Initialize checkbox state from localStorage
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('showReadToggle').checked = showRead;
            initSync(); // Start Firebase sync
            loadData();
        });
    </script>
</body>
</html>
